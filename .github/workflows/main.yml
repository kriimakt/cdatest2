name: Symfony 7 + Cypress E2E Tests

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  Symfony-test:
    runs-on: [self-hosted]

    steps:
      # ğŸ§¾ RÃ©cupÃ©ration du code
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ˜ Lancement du conteneur MySQL
      - name: Run MySQL container
        run: |
          docker run --name mysql-ci \
            -e MYSQL_ROOT_PASSWORD=root \
            -e MYSQL_DATABASE=app \
            -p 3306:3306 \
            -d mysql:8.0

      # ğŸ•’ Attente que MySQL soit prÃªt
      - name: Wait for MySQL to be ready
        run: |
          for i in {1..20}; do
            if docker exec mysql-ci mysqladmin ping -h "127.0.0.1" --silent; then
              echo "MySQL is up!"
              break
            fi
            echo "Waiting for MySQL..."
            sleep 3
          done

      # ğŸ§° Setup PHP
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, intl, pdo_mysql, sodium
          tools: composer  

      # ğŸ› ï¸ CrÃ©ation des fichiers d'environnement
      - name: Set up .env for CI
        run: |
          cp .env .env.test
          echo "APP_ENV=test" >> .env
          echo "APP_ENV=test" >> .env.test
          echo "DATABASE_URL=mysql://root:root@host.docker.internal:3306/app" >> .env.test

      # ğŸ“¦ Installation des dÃ©pendances PHP
      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist

      # ğŸ§± CrÃ©ation + migration base de donnÃ©es
      - name: Run database migrations
        run: |
          php bin/console doctrine:database:create --if-not-exists
          php bin/console doctrine:migrations:migrate --no-interaction

      # ğŸš€ Lancement du serveur Symfony en fond
      - name: Start Symfony server
        run: |
          php -S 127.0.0.1:8001 -t public &

      # ğŸ§ª Tests Cypress
      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          start: echo "Symfony already running"

      # ğŸ§¹ Nettoyage du conteneur MySQL
      - name: Cleanup MySQL container
        if: always()
        run: docker rm -f mysql-ci
